#
#	Top-level exnuc NT makefile
#

EXNUC: \
	echoenv \
	create_target_directories \
	transfer_makefiles_to_target_directory \
	create_make_tools \
	binaries \
	exnuc_objects

echoenv:
	@echo Build environment variables ...
	rem	EXNUC=$(EXNUC)
	rem	TARGET=$(TARGET)
	rem	BASE=$(BASE)
	rem	MAKEMAKE=$(MAKEMAKE)
	rem	ECHO=$(ECHO)
	rem	MAKE=$(MAKE)
	rem	CC=$(CC)
	rem	OS=$(OS)
	rem	DOPT1=$(DOPT1)
	rem	PRODUCT_NAME=$(PRODUCT_NAME)
	rem	PRODUCT_VERSION=$(PRODUCT_VERSION)
	rem	BUILD=$(BUILD)

create_make_tools:
	@echo Making make tools ...
	@cd $(TARGET)\bin
	@cd
	$(MAKE) -f extools.mknt

create_target_directories:
	@echo Creating target directories ...
	@if not exist $(TARGET)\lib mkdir $(TARGET)\lib
	@if not exist $(TARGET)\bin mkdir $(TARGET)\bin
	@if not exist $(TARGET)\exec mkdir $(TARGET)\exec
	@if not exist $(TARGET)\icob mkdir $(TARGET)\icob
	@if not exist $(TARGET)\message mkdir $(TARGET)\message
	@if not exist $(TARGET)\om mkdir $(TARGET)\om
	@if not exist $(TARGET)\om\IGRdir mkdir $(TARGET)\om\IGRdir
	@if not exist $(TARGET)\om\opp mkdir $(TARGET)\om\opp
	@if not exist $(TARGET)\package mkdir $(TARGET)\package
	@if not exist $(TARGET)\spec mkdir $(TARGET)\spec
	@if not exist $(TARGET)\trans mkdir $(TARGET)\trans

transfer_makefiles_to_target_directory:
	@echo Transfering makefiles to $(TARGET)
	@copy $(EXNUC)\bin\extools.mknt $(TARGET)\bin
	@copy $(EXNUC)\bin\mkmk.mknt $(TARGET)\bin
	@copy $(EXNUC)\makefile.nt $(TARGET)\makefile
	@copy $(EXNUC)\om\makefile.nt $(TARGET)\om\makefile
	@copy $(EXNUC)\om\opp\makefile.nt $(TARGET)\om\opp\makefile
	@copy $(EXNUC)\om\IGRdir\makefile.nt $(TARGET)\om\IGRdir\makefile
	rem copy $(EXNUC)\exec\makefile.nt $(TARGET)\exec\makefile
	rem copy $(EXNUC)\icob\makefile.nt $(TARGET)\icob\makefile
	rem copy $(EXNUC)\message\makefile.nt $(TARGET)\message\makefile
	rem copy $(EXNUC)\package\makefile.nt $(TARGET)\package\makefile
	rem copy $(EXNUC)\trans\makefile.nt $(TARGET)\trans\makefile

binaries: \
	MAKEMAKE \
	MKPTYPES \
	OM_BIN

#	ICOB_BIN \
#	EXEC_BIN \
#	TRANS_BIN

MAKEMAKE:
	@$(ECHO)
	@$(ECHO) "\\tMaking makemake ..."
	@cd $(TARGET)\bin
	@cd
	$(MAKE) -f mkmk.mknt

MKPTYPES: $(TARGET)\bin\mkptypes.mk
	@$(ECHO) "\\n\\tMaking mkptypes ..."
	@cd $(TARGET)\bin
	@cd
	$(MAKE) -f mkptypes.mk

$(TARGET)\bin\mkptypes.mk: $(EXNUC)\bin\mkptypes.m
	cd $(EXNUC)\bin
	$(MAKEMAKE) mkptypes.m $(TARGET)\bin\mkptypes.mk

OM_BIN:
	@$(ECHO) "\\n\\tMaking OM_BIN..."
	@cd $(TARGET)\om
	@cd
	$(MAKE) binaries

exnuc_objects:
	@cd $(TARGET)
	@$(MAKE) objects

#	We always want to force the following targets to be made every time.
#	These are psuedo-targets and should not match any existing file or
#	directory name.  On UNIX, we did this by making the names all upper-
#	case so they would not match directory names.  On, NTFS we append
#	a leading underbar since the filesystem is case insensitive.

#objects: \
#	_SPEC \
#	_OM \
#	_DICTIONARY \
#	_MESSAGE \
#	_ICOB \
#	_EXEC \
#	_RAP \
#	_IGEFEI

objects: \
	_SPEC \
	_OM 


_SPEC: $(TARGET)\spec\makefile
	@$(ECHO) "\\n\\tMaking spec ..."
	@cd $(TARGET)\spec
	@cd
	@$(MAKE)

$(TARGET)\spec\makefile: $(EXNUC)\spec\spec.m
	cd $(EXNUC)\spec
	$(MAKEMAKE) spec.m $(TARGET)\spec\makefile

_OM:
	@$(ECHO) "\\n\\tMaking OM ..."
	@cd $(TARGET)\om
	@cd
	@$(MAKE) objects

_DICTIONARY: $(TARGET)\dict\makefile $(TARGET)\dict\speclist $(TARGET)\dict\specdep
	@$(ECHO) "\\n\\tMaking dict ..."
	@cd $(TARGET)\dict
	@cd
	@$(MAKE)

$(TARGET)\dict\makefile: $(EXNUC)\dict\dict.m
	cd $(EXNUC)\dict
	$(MAKEMAKE) dict.m $(TARGET)\dict\makefile

_MESSAGE:
	@$(ECHO) "\\n\\tMaking message ..."
	@cd $(TARGET)\message
	@cd
	@$(MAKE)

_ICOB:
	@$(ECHO) "\\n\\tMaking icob ..."
	@cd $(TARGET)\icob
	@cd
	@$(EXNUC)\icob\version.bat
	@$(MAKE) objects

_EXEC: 
	@$(ECHO) "\\n\\tMaking exec ..."
	@cd $(TARGET)\exec
	@cd
	@$(MAKE) objects

_RAP: $(TARGET)\rap\makefile
	@$(ECHO) "\\n\\tMaking rap ..."
	@cd $(TARGET)\rap
	@cd
	@$(MAKE)

$(TARGET)\rap\makefile: $(EXNUC)\rap\rap.m
	cd $(EXNUC)\rap
	$(MAKEMAKE) rap.m $(TARGET)\rap\makefile
	
_IGEFEI: $(TARGET)\igefei\makefile
	@$(ECHO) "\\n\\tMaking igefei ..."
	@cd $(TARGET)\igefei
	@cd
	@$(MAKE)

$(TARGET)\igefei\makefile: $(EXNUC)\igefei\igefei.m
	cd $(EXNUC)\igefei
	$(MAKEMAKE) igefei.m $(TARGET)\igefei\makefile
