# Do not alter this line: $Revision: 1.1.54.1 $
#
#	Define tools
#
SPC=/usr/bin/spc

function Usage
{
	echo "Usage: $0 [-c] [-r] [-w <ws>] {risapp|riscli|riscom|rissrv|ristools|risutl}"
	echo "           -c : Compare only.  Don't download source from SPC."
	echo "           -r : Remove source downloaded from SPC if there are no differences."
	echo "      -w <ws> : Set working set to ws. Cannot be used with -c flag."
}

#
#	Process args
#
case $# in
	1)
		GET_SPC=1
		REMOVE_SPC=0
		SET_WS_FLAG=0
		PROJECT=$1;;

	2)
		if [ "$1" = "-c" ]
		then
			GET_SPC=0
			REMOVE_SPC=0
			SET_WS_FLAG=0
			PROJECT=$2
		elif [ "$1" = "-r" ]
		then
			GET_SPC=1
			REMOVE_SPC=1
			SET_WS_FLAG=0
			PROJECT=$2
		else
			Usage
			exit 1
		fi;;

	3)
		if [ "$1" = "-c" ]
		then
			if [ "$2" != "-r" ]
			then
				Usage
				exit 1
			fi
			GET_SPC=0
			REMOVE_SPC=1
			PROJECT=$3
		elif [ "$1" = "-r" ]
		then
			if [ "$2" != "-c" ]
			then
				Usage
				exit 1
			fi
			GET_SPC=0
			REMOVE_SPC=1
			PROJECT=$3
		elif [ "$1" = "-w" ]
		then
			GET_SPC=1
			REMOVE_SPC=0
			SET_WS_FLAG=1
			SET_WS=$2
			PROJECT=$3
		else
			Usage
			exit 1
		fi;;

	4)
		if [ "$1" = "-r" ]
		then
			if [ "$2" != "-w" ]
			then
				Usage
				exit 1
			fi
			GET_SPC=1
			REMOVE_SPC=1
			SET_WS_FLAG=1
			SET_WS=$3
			PROJECT=$4
		elif [ "$1" = "-w" ]
		then
			if [ "$3" != "-r" ]
			then
				Usage
				exit 1
			fi
			GET_SPC=1
			REMOVE_SPC=1
			SET_WS_FLAG=1
			SET_WS=$2
			PROJECT=$4
		else
			Usage
			exit 1
		fi;;
	*)
		Usage
		exit 1;;
esac

case $PROJECT in
	risapp|riscli|riscom|rissrv|ristools|risutl)
		break;;
	*)
		Usage
		exit;;
esac
	
#
#	Setup locations
#
PROJECT_LOCATION=$RISDEVDIR/$PROJECT
if [ "$TMPDIR" ]
then
	TEMP_LOCATION=$TMPDIR/$PROJECT
else
	TEMP_LOCATION=/usr/tmp/$PROJECT
fi

if [ "$GET_SPC" = "1" ]
then
#
#	Remove any leftover locations
#
	if [ -d $TEMP_LOCATION ]
	then
		rm -r $TEMP_LOCATION
	fi

#
#	Get spc files and place them in temp location
#
	echo
	echo "Downloading $PROJECT source into $TEMP_LOCATION"
	echo
	mkdir $TEMP_LOCATION

	cd $TEMP_LOCATION
	if [ "$SET_WS_FLAG" = "1" ]
	then
		$SPC -q <<-END
			set working set $SET_WS
			set proj $PROJECT
			fetch project
		END
	else
		$SPC -q <<-END
			set proj $PROJECT
			fetch project
		END
	fi
	cd -
fi

#
#	Compare spc source and local source
#
echo
echo "Comparing directories $TEMP_LOCATION and $PROJECT_LOCATION"
echo
cmpdir -s$PROJECT_LOCATION/build/spc.skp $TEMP_LOCATION $PROJECT_LOCATION

#
#	Check if temp source should be removed.
#
if [ $REMOVE_SPC = 1 -a $? = 0 ]
then
	if [ -d $TEMP_LOCATION ]
	then
		echo
		echo "Removing $PROJECT source from $TEMP_LOCATION"
		echo
		rm -r $TEMP_LOCATION
	fi
fi
