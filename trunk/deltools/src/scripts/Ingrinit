# script to initialize the ingrconfig file (in the event it's not up to date)

ARCH_LIST="SUN CLIPPER SPARC_SOLARIS INTEL_SOLARIS INTEL_SCO MIPS_IRIX HPPA_HPUX"

case `uname -s` in
SunOS)
    case `uname -r` in
    5.*)
	PLATFORM=Solaris
	case `uname -p` in
	sparc)
	    arch=SPARC_SOLARIS
	    ;;
	i386)
	    arch=INTEL_SOLARIS
	    ;;
	esac
	PRODDIR=ingr
	INGRHOME=${INGRHOME:=/opt/ingr}
	INGRHOME2=${INGRHOME%%:*}
	: ${INGRCONFIG:=$INGRHOME2/ingrconfig}
	LINKFLAG=-L
	FINDFLAGS="-local"
	export INGRHOME
	;;
    4.*)
	PLATFORM=SunOS_4
	arch=SUN
	PRODDIR=ip32
	: ${INGRCONFIG:=/usr/$PRODDIR/ingrconfig}
	LINKFLAG=-h
	FINDFLAGS="! -fstype nfs"
	;;
    esac
    ;;
CLIX)
    PLATFORM=CLIX
    arch=CLIPPER
    PRODDIR=ip32
    : ${INGRCONFIG:=/usr/$PRODDIR/ingrconfig}
    LINKFLAG=-L
    FINDFLAGS="-local"
    ;;
IRIX)
    case `uname -r` in
    5.*)
        PLATFORM=IRIX5
	arch=MIPS_IRIX
	PRODDIR=ingr
	INGRHOME=${INGRHOME:=/var/opt/ingr}
	INGRHOME2=${INGRHOME%%:*}
	: ${INGRCONFIG:=$INGRHOME2/ingrconfig}
	LINKFLAG=-L
	FINDFLAGS="-local"
	export INGRHOME
	;;
    4.*)
	PLATFORM=IRIX
	arch=MIPS_IRIX
	PRODDIR=ip32
	: ${INGRCONFIG:=/usr/$PRODDIR/ingrconfig}
	LINKFLAG=-L
	FINDFLAGS="-local"
	;;
    esac
    ;;
#mvr:06/1/94 
HP-UX )
    PLATFORM=HP_UX
    arch=HPPA_HPUX
    PRODDIR=ip32
    : ${INGRCONFIG:=/usr/$PRODDIR/ingrconfig}
    LINKFLAG=-h
    FINDFLAGS="-fsonly hfs"
    ;;

*)
    PLATFORM=SCO
    arch=INTEL_SCO
    PRODDIR=ip32
    : ${INGRCONFIG:=/usr/$PRODDIR/ingrconfig}
    LINKFLAG=-L
    FINDFLAGS="-local"
    ;;
esac

# ROOT should be NULL by default (to avoid a leading /)
: ${ROOT:=}

value() {       # Given a variable name and an architecture name,
                # return either the base variable or the modified value
    name='$'${arch}_$1
    eval value=$name
    if [ -n "$value" ]
    then
        echo $value
    else
        eval value='$'$1
        echo $value
    fi
}

echo "This utility initializes the \"$INGRCONFIG\" file. It does this"
echo "by searching directories for product.def files and then updates the"
echo "\"$INGRCONFIG\" file appropriately."
echo
if [ $PLATFORM = SunOS_4 ]
then
	/usr/bin/echo -n "Are you sure you want to do this (y/n)? [n]: "
else
	echo "Are you sure you want to do this (y/n)? [n]: \c"
fi
read ans

case ${ans:=n} in
n*|N*)
	echo
	echo
	echo "Bye."
	exit 1
	;;
esac

now=`date "+%T %D"`


if [ $PLATFORM = Solaris -o $PLATFORM = IRIX5 ]
then
    TAIL=$INGRHOME
    FPATH=${TAIL%%:*}
else
    FPATH=$ROOT/*/$PRODDIR 
fi

while [ "$FPATH" != "" ]
do
    find $FPATH $FINDFLAGS -name product.def -print > /tmp/files
    while read file
    do
	dir=`dirname $file`

	[ ! -z "$ROOT" ] && dir=`echo $dir | sed -e "s!$ROOT!!"`

	# skip symbolic linked products
	[ $LINKFLAG $dir ] && continue

	. $file

    echo "`value IDnumber`#`value IDname`#`value IDtitle`#`value IDversion`#`value IDdate`#$dir#$now#Ingrinit#"

	unset IDnumber IDname IDtitle IDversion IDdate
	for carch in $ARCH_LIST
	do
	    unset ${carch}_IDnumber ${carch}_IDname ${carch}_IDtitle ${carch}_IDversion ${carch}_IDdate
	done
    done < /tmp/files >$INGRCONFIG

    TAIL2=${TAIL#*:}
    if [ "$TAIL2" = "$TAIL" ]
    then
	TAIL=""
    else
	TAIL=$TAIL2
    fi
    FPATH=${TAIL%%:*}
done
rm -f /tmp/files > /dev/null 2>&1
echo
echo
echo "Done."

exit 0
