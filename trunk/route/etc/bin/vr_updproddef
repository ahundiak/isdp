#!/bin/ksh
# $Id: vr_updproddef,v 1.3 2002/04/30 18:25:45 anand Exp $

# -------------------------------------------------------------------
# I/ROUTE
#
# File:	route/etc/bin/vr_updproddef 
#
# Description:
#
# Dependencies:
#
# Revision History:
#	$Log: vr_updproddef,v $
#	Revision 1.3  2002/04/30 18:25:45  anand
#	#!Shebang line has to be the first line in a script#!
#	
#	Revision 1.2  2002/02/20 18:36:05  anand
#	Got I/Route to be in sync with other products - Route was the only
#	one with etc/release; everybody else used etc/version. Changed script
#	to accommodate this.
#	
#	Revision 1.1.1.1  2001/01/04 21:12:07  cvs
#	Initial import to CVS
#	
# Revision 1.1  1995/12/06  14:16:04  pinnacle
# Created: etc/bin/vr_updproddef by r240_int for route240
#
# History:
#	MM/DD/YY	AUTHOR		DESCRIPTION
#	12/04/95	tlb		created from vd_updproddef
#
# -------------------------------------------------------------------

#	This shell script updates the product.def file.
#
#-------------------------------------------------------------------------------
function Info {
	echo "$*" >&2
	return 0
} # Info
#-------------------------------------------------------------------------------
function Tput {
	/usr/bin/tput $1 >&2
} # Tput
#-------------------------------------------------------------------------------
function Header {
	Tput smul ; Info "$*" ; Tput rmul ;
} # Header
#-------------------------------------------------------------------------------
function getDate {

	integer rc
	echo `/bin/date '+%d-%b-%Y'		\
		| /bin/sed	-e "s/a/A/g"	\
				-e "s/b/B/g"	\
				-e "s/c/C/g"	\
				-e "s/d/D/g"	\
				-e "s/e/E/g"	\
				-e "s/f/F/g"	\
				-e "s/g/G/g"	\
				-e "s/h/H/g"	\
				-e "s/i/I/g"	\
				-e "s/j/J/g"	\
				-e "s/k/K/g"	\
				-e "s/l/L/g"	\
				-e "s/m/M/g"	\
				-e "s/n/N/g"	\
				-e "s/o/O/g"	\
				-e "s/p/P/g"	\
				-e "s/q/Q/g"	\
				-e "s/r/R/g"	\
				-e "s/s/S/g"	\
				-e "s/t/T/g"	\
				-e "s/u/U/g"	\
				-e "s/v/V/g"	\
				-e "s/w/W/g"	\
				-e "s/x/X/g"	\
				-e "s/y/Y/g"	\
				-e "s/z/Z/g"`
	rc=0
	return ${rc}

} # getDate
#-------------------------------------------------------------------------------
function updateDate {

	integer rc
	typeset newdate opt tmp locdef

	Header "\n\tUpdating release date"

	newdate=`getDate`

	Info "\tNew date: ${newdate}"

	locdef="${VRprodDef}"
	olddate=`/usr/bin/awk -F= '/IDdate/ { print $2 ; }' ${locdef}`
	rc=$?

	if [ ${rc} -eq 0 -a -n "${olddate}" ] ; then
		opt="s/IDdate=${olddate}/IDdate=${newdate}/"
		tmp="${TMPDIR}/tmpdef"

		if /bin/sed -e "${opt}" ${locdef} > ${tmp} ; then
			/bin/mv ${tmp} ${locdef}
		else
			Info "** Cannot update date in ${locdef}"
		fi
	else
		Info "** Cannot get old version from ${locdef}"
		rc=1
		return ${rc}
	fi

	return ${rc}

} # updateDate
#-------------------------------------------------------------------------------
function getNewVersion {

#
#	Get release version number from user.
#
	typeset newversion garbage
	integer rc

	Info "Preceeding version of ROUTE was: $1"

	while : ; do
		Info "\nKey in new version (rr.uu.ss.tt) > \c"
		read newversion garbage
		if [ -z "${newversion}" ] ; then
			Info "** Invalid version number."
		elif [ ${newversion} = $1 ] ; then
			Info "** New version identical to preceeding one."
		else
			set `echo ${newversion} \
				| /usr/bin/awk -F. \
					'{ print $1 " " $2 " " $3 " " $4 ; }' \
					-`
			rc=0
			checkVal "rr" $1 ; rc=`/bin/expr ${rc} + $?`
			checkVal "uu" $2 ; rc=`/bin/expr ${rc} + $?`
			checkVal "ss" $3 ; rc=`/bin/expr ${rc} + $?`
			checkVal "tt" $4 ; rc=`/bin/expr ${rc} + $?`
			if [ ${rc} -eq 0 ] ; then
				echo ${newversion}
				break ;
			fi
		fi
	done

	return ${rc}

} # getNewVersion
#-------------------------------------------------------------------------------
function updateVersion {

#
#	Update release version number in "product.def" file.
#
	integer rc
	typeset localdef deldef oldversion newversion opt tmp

	Header "\n\tUpdating product.def"

	locdef="${VRprodDef}"

	oldversion=`/usr/bin/awk			\
			-F=				\
			'/IDversion/ { print $2 ; }'	\
			${locdef}`
	rc=$?
	if [ ${rc} -eq 0 -a -n "${oldversion}" ] ; then

		newversion=`getNewVersion ${oldversion}`

		opt="s/IDversion=${oldversion}/IDversion=${newversion}/"
		tmp="${TMPDIR}/tmpdef"
		if /bin/sed -e "${opt}" ${locdef} > ${tmp} ; then
			/bin/mv ${tmp} ${locdef}
		else
			Info "** Cannot update version in ${locdef}"
		fi
	else
		Info "** Cannot get old version from ${locdef}"
		rc=1
	fi

	return ${rc}

} # updateVersion
#-------------------------------------------------------------------------------
function checkVal {

#
#	Make sure input numbers consist in two digits.
#
	typeset name val
	integer rc number

	name=$1 ; val=$2

	if [ -n "${val}" ] ; then
		if [ `/bin/expr ${val} : '.*'` -eq 2 ] ; then
			if let number=${val} >/dev/null 2>&1 ; then
				:
			elif [ ${val} != "00" ] ; then
				Info "** '${name}=${val}' is not a number."
				rc=1
			else
				rc=0
			fi
			
		else
			Info "** '${name}' must have 2 characters."
			rc=1
		fi
	else
		Info "** '${name}' has no value."
		rc=1
	fi
	return ${rc}

} # checkVal
#-------------------------------------------------------------------------------
function checkDirs {

	integer RC
	typeset oldProdDef relDir oldProdDefHv

	if [ -z "${ROUTE}" ] ; then
		Info "** Environment variable '$ROUTE' not initialized."
		RC=1
	else
		if [ -z "${TMPDIR}" ] ; then
			TMPDIR="/usr/tmp"
		fi
		relDir="${ROUTE}/etc/version"
		VRprodDef="${relDir}/product.def"

		if [ ! -w ${VRprodDef} ] ; then
			Info "** Cannot read ${VRprodDef}."
			RC=1
		else
			oldProdDef="VRpdef`/bin/date '+%d%b%Y'`"
			oldProdDef="${relDir}/${oldProdDef}"
			Header "\n\t\tSaving product.def to ${oldProdDef}\t"
			if /bin/cp ${VRprodDef} ${oldProdDef} ; then
				RC=0
			else
				RC=$?
				Info "** Cannot copy product.def."
			fi	
		fi
	fi
		
	return ${RC}

} # checkDirs
#-------------------------------------------------------------------------------
#
#	Init globals.
#

Header "\n\t\tUpdating of 'product.def'\n"

VRprodDef=""
TMPDIR="."


if checkDirs ; then
	if updateDate ; then
		updateVersion
		RC=$?
	else
		RC=$?
	fi
else
	RC=$?
fi

exit ${RC}
