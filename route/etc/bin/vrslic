#!/bin/ksh
# $Id: vrslic,v 1.2 2002/04/30 18:25:45 anand Exp $

#**********************************************************************
# File:		etc/bin/ vrslic
#
# Description:
#	script to run slic on a given directory
#
# Dependencies:
#
# Revision History:
#	$Log: vrslic,v $
#	Revision 1.2  2002/04/30 18:25:45  anand
#	#!Shebang line has to be the first line in a script#!
#	
#	Revision 1.1.1.1  2001/01/04 21:12:08  cvs
#	Initial import to CVS
#	
# Revision 1.4  1996/03/04  21:51:02  pinnacle
# Replaced: etc/bin/vrslic for:  by hverstee for route240
#
# Revision 1.3  1996/03/01  22:13:56  pinnacle
# Replaced: etc/bin/vrslic for:  by hverstee for route240
#
# Revision 1.2  1995/12/08  21:27:12  pinnacle
# Replaced: etc/bin/vrslic for:  by r240_int for route240
#
#
# History:
#	MM/DD/YY	AUTHOR		DESCRIPTION
#	12/05/95	tlb		Make execution directory independent
#					Adapt to run on any ROUTE directory
#
#
#**********************************************************************

integer putinslic
msg=0

#--------------------------------------------
function Msg {

	if [ msg -eq 0 ] ; then
		# User message
		echo "\n\t\c"
		/usr/bin/tput smul
		echo "Slic in ${DIR}"
		/usr/bin/tput rmul
		msg=1
	fi
}
	
#-------------------------------------------
function Makelist_sl {
	DOT_M=${DIR}/`basename ${DIR}`.m
	let putinslic=0
	slicList=""
        for i in *.sl ;do
		DOT_S=${i%.sl}.S
		DOT_I=${i%.sl}i.I

		# check against *.S file
		if grep "${DOT_S}" "${DOT_M}" >/dev/null 2>&1 ; then
			if    [ ${i} -nt ./${DOT_S} ] ; then
				putinslic=1
			elif [ ! -f ./${DOT_S} ] ; then
				echo "${DOT_S} not found will be created"
				/bin/touch ./${i}
				putinslic=1
			fi
		else
			echo "  WARNING ${DOT_S} not in ${DOT_M}"
		fi

		# check against *i.I file
		if grep "${DOT_I}" "${DOT_M}" >/dev/null 2>&1 ; then
			if [ ./${i} -nt ./${DOT_I} ] ; then
				putinslic=1
			elif [ ! -f ./${DOT_I} ] ; then
				echo "${DOT_I} not found"
				/bin/touch ./${i}
				putinslic=1
			fi
		else
			echo "  WARNING ${DOT_I} not in ${DOT_M}"
		fi

		#
 		# check against command file
		#
		CMD=`\awk -F, '/command_string/ { print $3; }' ${i} | \
				sed 's/ //g' ` 
		CMDFILE=${ROUTE}/config/commands/${CMD}
		if    [ ! -f ${CMDFILE} ] \
		   || [ ${i} -nt ${CMDFILE} ] \
		   || [ ${ROUTE}/vrinclude/VRmsg.h -nt ${CMDFILE} ] 
				then putinslic=1
		fi
		

		if [ $putinslic -eq 1 ]
		then 
			#echo "   ADDING ${i} IN SLIC LIST"
			slicList=${slicList}" "${i}
			putinslic=0
		fi
        done
}
#-------------------------------------------
function Makelist_t {
	slicList=""
	for i in *.t ; do
		CMD=`\awk -F, '/command_string/ { print $3; }' ${i} | \
				sed 's/ //g' ` 
		CMDFILE=${ROUTE}/config/commands/${CMD}
		
		if    [ ! -f ${CMDFILE} ] \
		   || [ ${i} -nt ${CMDFILE} ] \
		   || [ ${ROUTE}/vrinclude/VRmsg.h -nt ${CMDFILE} ] 
				then slicList=${slicList}" "${i}
		fi
	done
}
#-------------------------------------------
function Slic_sl {
	RC=0
	if [ -n "${slicList}" ] ; then
		Msg;
		echo "   Slic *.sl list = ${slicList} "
	
		slicOPT="${slicOPT} -C"
		slicRC=0
		for DOT_SL in ${slicList} ; do
			echo "\n\tSlic-ing ${DOT_SL}:"
			echo "\t\toptions ${slicOPT}"
	
			Class=`/bin/basename ${DOT_SL}`
			Class=${Class%.sl}
	
			${EXNUC}/bin/slic ${slicOPT} ./${DOT_SL}
			RC1=$?
			if [ ${RC1} -ne 0 ] ; then
				if [ ${slicRC} -eq 0 ] ; then
					slicRC=${RC1}
				fi
			else
				if ( echo ${slicOPT} | /usr/bin/fgrep -e "-s" \
							> /dev/null ) ; then
					/bin/touch -c ${Class}.S
					/bin/touch -c ${Class}.o
				fi
				if ( echo ${slicOPT} | /usr/bin/fgrep -e "-i" \
							> /dev/null ) ; then
					/bin/touch -c ${Class}i.I
					/bin/touch -c ${Class}i.o
				fi
			fi
		done
	
		RC=${slicRC}
		echo "\n"
	else
		echo "\tNo .sl files to slic"
	fi
}
#-------------------------------------------
function Slic_t {
	RC=0
	if [ -n "${slicList}" ] ; then

		Msg;
		echo "   Slic *.t list = ${slicList} "
		slicOPT="-Csi -p$VDS/spec -p$ROUTE/spec"

		for DOT_T in ${slicList} ; do

			echo "\tSlic-ing ${DOT_T}"
			echo "\t\toptions ${slicOPT}\n"
			${EXNUC}/bin/slic ${slicOPT} ${DOT_T}
			RC1=$?
			if [ ${RC1} -ne 0 ] ; then
				slicRC=${RC1}
			fi
		done
		RC=${slicRC}
		echo "\n"
	else
		echo "\tNo .t files to slic"
	fi
}
#-------------------------------------------
	
	# Check usage
	if [ $# = 0 ] ; then
		echo "\nUsage: vrslic -i -s -m <directory>\n\
			-i : do not generate .I files\n\
			-s : do not generate .S files\n\
			<directory> contains the .sl files\n"
		exit 2
	fi
	slicOPT="-p$VDS/spec -p$ROUTE/spec"
	
	# Read options
	set -- `/usr/bin/getopt is $*`
	if [ $? != 0 ] ; then
		echo "\nOptions: -i -s"
		exit 2
	fi
	
	# set options
	for i in $* ; do
		case $i in
			-i) slicOPT="${slicOPT} -i" ; shift;;
			-s) slicOPT="${slicOPT} -s" ; shift;;
			--) shift; break;;
		esac
	done
	
	# setup directory name
	DIR=$1
	if [ -z "${DIR}" ] ; then
		echo "\tNo directory specified\n"
		exit 2
	fi
	if [ ${DIR} = "." ] ; then
		DIR=${PWD}
	elif [ "${DIR}" = "`basename ${DIR}`" ] ; then
		DIR=${ROUTE}/${DIR}
	fi
	if [ ! -d ${DIR} ]
		then echo "no such ROUTE directory: $DIR "; exit 1;
	fi
	
	# check if any *.sl or *.t files exist
	#	be careful - 
	#	     ls fails returns fail if it doesn't match all patterns
	#
	\cd ${DIR} 
	if ! /bin/ls ./*.sl >/dev/null 2>&1 ; then 
		if ! /bin/ls ./*.t >/dev/null 2>&1 
			then exit 0;
		fi
	fi
	/bin/rm ./TFILE* > /dev/null 2>&1
	
	
	# 
	# Slic the *.sl files
	#
	if /bin/ls ./*.sl > /dev/null 2>&1 ; then
		Makelist_sl
		Slic_sl
		if [ ${RC} -ne 0 ] ; 
			then exit ${RC};
		fi
	fi
	
	#
	# Slic *.t files
	#
	if /bin/ls ./*.t > /dev/null 2>&1 ; then
		Makelist_t;
		Slic_t;
	fi
	
	exit ${RC}
